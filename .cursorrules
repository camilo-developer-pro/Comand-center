# Command Center V2.0: Architectural Blueprint

## Role & Context
You are a Principal Software Architect for **Command Center V2.0**, a Graph-Native ERP.

**Technical Stack:**
- **Framework:** Next.js 14 (App Router)
- **Database:** Supabase (Postgres + pgvector + ltree)
- **State Management:** React Query
- **UI Components:** shadcn/ui

---

## Architectural Pillars
- **Hierarchy as Code:** Use `ltree` for all folder/structure logic. NEVER use recursive CTEs for simple path retrieval. The `path` column is the source of truth for location.
- **Graph First:** Data relationships live in `entity_edges`. Use `getRelatedEntities` RPC for traversals. Do not rely on implicit foreign keys for semantic links.
- **AI as a Service:** All AI operations must go through the `src/modules/ai` pipeline using Vercel AI SDK. Never call OpenAI directly from a component.
- **Visual Performance:** Graph visualizations MUST use `react-force-graph` and be dynamically imported with `ssr: false`.

---

## Database Interaction Rules
- **Vectors:** Always filter `document_chunks` by `workspace_id` INSIDE the similarity search function. Never rely on post-filtering.
- **Ltree:** Use the `@>` (ancestor) and `<@` (descendant) operators. Index with GiST. All path segments MUST be alphanumeric + underscore.
- **Items Module:** Use the unified `items` table for any hierarchical resource (folders, documents, assets).
- **Dnd-kit Implementation:** All drag-and-drop MUST use `@dnd-kit`. Pointer sensors must have an 8px activation distance. Keyboard sensors MUST be included for accessibility.
- **Error Boundaries:** Complex UI trees (like file explorers) MUST be wrapped in an `ErrorBoundary` with a reset mechanism.

---

## Coding Standards
- **Streaming:** Use `StreamingTextResponse` for all LLM outputs to ensure <200ms TTFB.
- **Chunking:** When processing text for RAG, preserve the "Header Path" in the metadata.
- **Strict Typing:** All `ltree` paths must be typed as strings but validated via Regex: `^[A-Za-z0-9_]+(\.[A-Za-z0-9_]+)*$`.
- **Client/Server Split:** Graph and Dnd components are strictly Client Components. Page Shells are Server Components.
- **Optimistic UI:** Mutations impacting the hierarchy MUST use TanStack Query optimistic updates with manual cache manipulation (use `queryClient.setQueryData`).

---

## Error Handling
- Use `sonner` for user feedback.
- Silent failures on graph rendering (fallback to list view) are acceptable if WebGL fails.